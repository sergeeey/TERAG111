{
  "name": "TERAG Multilingual Support",
  "description": "Добавление поддержки русского и английского языков в TERAG AI-REPS",
  "version": "1.0",
  "steps": [
    {
      "id": "install_langdetect",
      "name": "Установка библиотеки определения языка",
      "description": "Устанавливаем langdetect для автоматического определения языка документов",
      "commands": [
        "pip install langdetect"
      ],
      "verification": "python -c \"from langdetect import detect; print('Language detection ready')\""
    },
    {
      "id": "update_doc_converter",
      "name": "Обновление конвертера документов",
      "description": "Добавляем автоматическое определение языка в doc_converter.py",
      "files": [
        {
          "path": "src/core/doc_converter.py",
          "action": "update",
          "content": "import os\nfrom pathlib import Path\nfrom docx import Document\nfrom PyPDF2 import PdfReader\nimport pandas as pd\nfrom langdetect import detect\nimport logging\n\nlogging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')\nlogger = logging.getLogger(__name__)\n\ndef detect_language(text):\n    \"\"\"Определяет язык текста\"\"\"\n    try:\n        if len(text.strip()) < 10:\n            return \"unknown\"\n        lang = detect(text)\n        return \"ru\" if lang == \"ru\" else \"en\"\n    except Exception as e:\n        logger.warning(f\"Language detection failed: {e}\")\n        return \"unknown\"\n\ndef extract_text_from_docx(path):\n    \"\"\"Извлекает текст из DOCX файла\"\"\"\n    try:\n        doc = Document(path)\n        text = \"\\n\".join(p.text for p in doc.paragraphs)\n        return text\n    except Exception as e:\n        logger.error(f\"Ошибка извлечения текста из DOCX {path}: {e}\")\n        return \"\"\n\ndef extract_text_from_pdf(path):\n    \"\"\"Извлекает текст из PDF файла\"\"\"\n    try:\n        text = \"\"\n        reader = PdfReader(path)\n        for page in reader.pages:\n            text += page.extract_text() + \"\\n\"\n        return text\n    except Exception as e:\n        logger.error(f\"Ошибка извлечения текста из PDF {path}: {e}\")\n        return \"\"\n\ndef extract_text_from_xlsx(path):\n    \"\"\"Извлекает текст из XLSX файла\"\"\"\n    try:\n        df = pd.read_excel(path)\n        return df.to_string(index=False)\n    except Exception as e:\n        logger.error(f\"Ошибка извлечения текста из XLSX {path}: {e}\")\n        return \"\"\n\ndef convert_all_to_txt(data_dir=\"data\"):\n    \"\"\"Конвертирует все документы в текст с определением языка\"\"\"\n    data_dir = Path(data_dir)\n    txt_dir = data_dir / \"converted\"\n    txt_dir.mkdir(parents=True, exist_ok=True)\n    \n    converted_count = 0\n    error_count = 0\n    \n    # Обработка DOCX файлов\n    docx_files = list(data_dir.rglob(\"*.docx\"))\n    logger.info(f\"Найдено {len(docx_files)} файлов с расширением .docx\")\n    \n    for file_path in docx_files:\n        if file_path.name.startswith('~$'):\n            continue\n        \n        logger.info(f\"Обрабатываем: {file_path.name}\")\n        content = extract_text_from_docx(file_path)\n        \n        if content.strip():\n            lang = detect_language(content)\n            output_filename = f\"{file_path.stem}_{lang}.txt\"\n            output_path = txt_dir / output_filename\n            \n            output_path.write_text(content, encoding=\"utf-8\")\n            logger.info(f\"Конвертирован: {file_path.name} → {output_filename} ({len(content)} символов, язык: {lang})\")\n            converted_count += 1\n        else:\n            logger.warning(f\"Пустой файл: {file_path.name}\")\n            error_count += 1\n    \n    # Обработка PDF файлов\n    pdf_files = list(data_dir.rglob(\"*.pdf\"))\n    logger.info(f\"Найдено {len(pdf_files)} файлов с расширением .pdf\")\n    \n    for file_path in pdf_files:\n        logger.info(f\"Обрабатываем: {file_path.name}\")\n        content = extract_text_from_pdf(file_path)\n        \n        if content.strip():\n            lang = detect_language(content)\n            output_filename = f\"{file_path.stem}_{lang}.txt\"\n            output_path = txt_dir / output_filename\n            \n            output_path.write_text(content, encoding=\"utf-8\")\n            logger.info(f\"Конвертирован: {file_path.name} → {output_filename} ({len(content)} символов, язык: {lang})\")\n            converted_count += 1\n        else:\n            logger.warning(f\"Пустой файл: {file_path.name}\")\n            error_count += 1\n    \n    # Обработка XLSX файлов\n    xlsx_files = list(data_dir.rglob(\"*.xlsx\"))\n    logger.info(f\"Найдено {len(xlsx_files)} файлов с расширением .xlsx\")\n    \n    for file_path in xlsx_files:\n        if file_path.name.startswith('~$'):\n            continue\n        \n        logger.info(f\"Обрабатываем: {file_path.name}\")\n        content = extract_text_from_xlsx(file_path)\n        \n        if content.strip():\n            lang = detect_language(content)\n            output_filename = f\"{file_path.stem}_{lang}.txt\"\n            output_path = txt_dir / output_filename\n            \n            output_path.write_text(content, encoding=\"utf-8\")\n            logger.info(f\"Конвертирован: {file_path.name} → {output_filename} ({len(content)} символов, язык: {lang})\")\n            converted_count += 1\n        else:\n            logger.warning(f\"Пустой файл: {file_path.name}\")\n            error_count += 1\n    \n    # Обработка существующих TXT файлов\n    txt_files = list(data_dir.rglob(\"*.txt\"))\n    logger.info(f\"Найдено {len(txt_files)} файлов с расширением .txt\")\n    \n    for file_path in txt_files:\n        if file_path.parent == txt_dir:\n            continue  # Пропускаем уже конвертированные файлы\n        \n        logger.info(f\"Обрабатываем: {file_path.name}\")\n        try:\n            content = file_path.read_text(encoding=\"utf-8\")\n            if content.strip():\n                lang = detect_language(content)\n                output_filename = f\"{file_path.stem}_{lang}.txt\"\n                output_path = txt_dir / output_filename\n                \n                output_path.write_text(content, encoding=\"utf-8\")\n                logger.info(f\"Конвертирован: {file_path.name} → {output_filename} ({len(content)} символов, язык: {lang})\")\n                converted_count += 1\n        except Exception as e:\n            logger.error(f\"Ошибка обработки {file_path.name}: {e}\")\n            error_count += 1\n    \n    logger.info(f\"Конвертация завершена:\")\n    logger.info(f\"   Успешно: {converted_count} файлов\")\n    logger.info(f\"   Ошибок: {error_count} файлов\")\n    logger.info(f\"   Результат: {txt_dir}\")\n    \n    return txt_dir\n\ndef get_converted_files(converted_dir=\"data/converted\"):\n    \"\"\"Возвращает список конвертированных файлов\"\"\"\n    converted_path = Path(converted_dir)\n    if not converted_path.exists():\n        return []\n    \n    files = list(converted_path.glob(\"*.txt\"))\n    logger.info(f\"Найдено {len(files)} конвертированных файлов\")\n    return files\n\nif __name__ == \"__main__\":\n    convert_all_to_txt()"
        }
      ]
    },
    {
      "id": "update_kag_builder",
      "name": "Обновление KAG Builder",
      "description": "Добавляем поддержку языков в построение графа знаний",
      "files": [
        {
          "path": "src/core/kag_builder.py",
          "action": "update",
          "content": "import os\nimport sys\nimport json\nfrom datetime import datetime\nfrom pathlib import Path\nimport re\n\n# Добавляем корневую директорию в путь\nsys.path.append(str(Path(__file__).parent.parent.parent))\n\nfrom src.core.doc_converter import convert_all_to_txt, get_converted_files\n\n# Автоматическая конвертация документов\nprint(\"Starting document conversion...\")\nCONVERTED_DIR = convert_all_to_txt(\"data\")\nprint(f\"Conversion completed. Files in: {CONVERTED_DIR}\")\n\n# Папка с конвертированными документами\nDATA_DIR = CONVERTED_DIR\n\n# Папка, куда будут сохраняться результаты\nOUTPUT_DIR = Path(\"data\") / \"graph_results\"\nOUTPUT_DIR.mkdir(parents=True, exist_ok=True)\n\ndef extract_triplets_ru(text):\n    \"\"\"Извлекает триплеты из русского текста\"\"\"\n    triplets = []\n    sentences = text.split('.')\n    \n    for sentence in sentences:\n        sentence = sentence.strip()\n        if len(sentence) < 10:\n            continue\n        \n        # Простая логика для русского текста\n        words = sentence.split()\n        if len(words) >= 3:\n            # Ищем паттерны типа \"субъект действие объект\"\n            for i in range(len(words) - 2):\n                subject = words[i]\n                predicate = words[i + 1]\n                obj = words[i + 2]\n                \n                # Фильтруем короткие слова\n                if len(subject) > 2 and len(predicate) > 2 and len(obj) > 2:\n                    triplets.append({\n                        'subject': subject,\n                        'predicate': predicate,\n                        'object': obj,\n                        'confidence': 0.7,\n                        'language': 'ru'\n                    })\n    \n    return triplets\n\ndef extract_triplets_en(text):\n    \"\"\"Извлекает триплеты из английского текста\"\"\"\n    triplets = []\n    sentences = text.split('.')\n    \n    for sentence in sentences:\n        sentence = sentence.strip()\n        if len(sentence) < 10:\n            continue\n        \n        # Простая логика для английского текста\n        words = sentence.split()\n        if len(words) >= 3:\n            # Ищем паттерны типа \"subject verb object\"\n            for i in range(len(words) - 2):\n                subject = words[i]\n                predicate = words[i + 1]\n                obj = words[i + 2]\n                \n                # Фильтруем короткие слова\n                if len(subject) > 2 and len(predicate) > 2 and len(obj) > 2:\n                    triplets.append({\n                        'subject': subject,\n                        'predicate': predicate,\n                        'object': obj,\n                        'confidence': 0.7,\n                        'language': 'en'\n                    })\n    \n    return triplets\n\ndef extract_triplets(text, language=\"ru\"):\n    \"\"\"Извлекает триплеты в зависимости от языка\"\"\"\n    if language == \"en\":\n        return extract_triplets_en(text)\n    else:\n        return extract_triplets_ru(text)\n\ndef process_document(file_path):\n    \"\"\"Обрабатывает один документ и извлекает триплеты\"\"\"\n    try:\n        content = file_path.read_text(encoding=\"utf-8\")\n        \n        # Определяем язык из имени файла\n        filename = file_path.stem\n        if filename.endswith('_en'):\n            language = \"en\"\n        elif filename.endswith('_ru'):\n            language = \"ru\"\n        else:\n            language = \"ru\"  # По умолчанию русский\n        \n        triplets = extract_triplets(content, language)\n        \n        # Сохраняем результат\n        result = {\n            'filename': file_path.name,\n            'language': language,\n            'triplets': triplets,\n            'processed_at': datetime.now().isoformat(),\n            'total_triplets': len(triplets)\n        }\n        \n        output_file = OUTPUT_DIR / f\"{file_path.stem}_graph.json\"\n        with open(output_file, 'w', encoding='utf-8') as f:\n            json.dump(result, f, ensure_ascii=False, indent=2)\n        \n        print(f\"Processed: {file_path.name} ({len(triplets)} triplets, language: {language})\")\n        return len(triplets)\n        \n    except Exception as e:\n        print(f\"Error processing {file_path.name}: {e}\")\n        return 0\n\ndef run_batch_processing():\n    \"\"\"Запускает пакетную обработку всех документов\"\"\"\n    files = get_converted_files(DATA_DIR)\n    \n    if not files:\n        print(\"No converted files found\")\n        return\n    \n    print(f\"Found {len(files)} converted files\")\n    print(\"Starting batch processing...\")\n    \n    total_triplets = 0\n    processed_docs = 0\n    \n    for file_path in files:\n        triplets_count = process_document(file_path)\n        total_triplets += triplets_count\n        processed_docs += 1\n    \n    # Создаем сводный отчет\n    summary = {\n        'processed_documents': processed_docs,\n        'total_triplets': total_triplets,\n        'average_triplets_per_doc': total_triplets / processed_docs if processed_docs > 0 else 0,\n        'processed_at': datetime.now().isoformat(),\n        'languages': {\n            'ru': len([f for f in files if f.stem.endswith('_ru')]),\n            'en': len([f for f in files if f.stem.endswith('_en')])\n        }\n    }\n    \n    summary_file = OUTPUT_DIR / \"processing_summary.json\"\n    with open(summary_file, 'w', encoding='utf-8') as f:\n        json.dump(summary, f, ensure_ascii=False, indent=2)\n    \n    print(f\"\\nProcessing completed:\")\n    print(f\"   Processed: {processed_docs} documents\")\n    print(f\"   Extracted: {total_triplets} triplets\")\n    print(f\"   Results: {OUTPUT_DIR}\")\n    print(f\"   Summary: {summary_file}\")\n\ndef build_kag_graph(converted_dir=None):\n    \"\"\"Строит граф знаний из конвертированных документов\"\"\"\n    if converted_dir:\n        global DATA_DIR\n        DATA_DIR = Path(converted_dir)\n    \n    print(\"Building knowledge graph...\")\n    run_batch_processing()\n    print(\"Knowledge graph built!\")\n\nif __name__ == \"__main__\":\n    run_batch_processing()"
        }
      ]
    },
    {
      "id": "update_api_server",
      "name": "Обновление API сервера",
      "description": "Добавляем поддержку языков в API",
      "files": [
        {
          "path": "src/api/server.py",
          "action": "update",
          "content": "from fastapi import FastAPI, Body, Response\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.staticfiles import StaticFiles\nfrom datetime import datetime, timezone\nimport os\nimport json\nfrom pathlib import Path\nfrom src.core.metrics import get_metrics_snapshot\nfrom src.core.health import get_health\nfrom src.core.self_learning import accept_feedback\n\napp = FastAPI(title=\"TERAG AI-REPS API\", version=\"1.0.0\")\n\n# CORS middleware\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# Добавляем поддержку статических файлов\nstatic_dir = os.path.join(os.path.dirname(__file__), \"static\")\napp.mount(\"/api/static\", StaticFiles(directory=static_dir), name=\"static\")\n\n@app.get(\"/\")\ndef read_root():\n    return {\"message\": \"TERAG AI-REPS API\", \"version\": \"1.0.0\", \"status\": \"running\"}\n\n@app.get(\"/api/metrics\")\ndef get_metrics():\n    return get_metrics_snapshot()\n\n@app.get(\"/api/health\")\ndef get_health_status():\n    return get_health()\n\n@app.post(\"/api/feedback\")\ndef post_feedback(payload: dict = Body(...)):\n    result = accept_feedback(payload)\n    return {\"status\": \"ok\", \"result\": result}\n\n@app.get(\"/api/graph\")\ndef get_knowledge_graph():\n    \"\"\"Получение графа знаний из обработанных документов\"\"\"\n    try:\n        # Читаем все графы из graph_results\n        graph_results_dir = Path(\"data/graph_results\")\n        if not graph_results_dir.exists():\n            return {'graph': [], 'edges': [], 'metadata': {'total_nodes': 0, 'total_edges': 0}}\n        \n        all_nodes = []\n        all_edges = []\n        total_triplets = 0\n        processed_docs = 0\n        languages = {'ru': 0, 'en': 0}\n        \n        # Собираем все триплеты из файлов графов\n        for graph_file in graph_results_dir.glob(\"*_graph.json\"):\n            if graph_file.name == \"processing_summary.json\":\n                continue\n                \n            try:\n                with open(graph_file, 'r', encoding='utf-8') as f:\n                    data = json.load(f)\n                \n                triplets = data.get('triplets', [])\n                language = data.get('language', 'ru')\n                total_triplets += len(triplets)\n                processed_docs += 1\n                languages[language] += 1\n                \n                # Преобразуем триплеты в узлы и связи\n                for i, triplet in enumerate(triplets):\n                    subject = triplet.get('subject', 'Unknown')\n                    predicate = triplet.get('predicate', 'relates_to')\n                    obj = triplet.get('object', 'Unknown')\n                    confidence = triplet.get('confidence', 0.5)\n                    \n                    # Создаём узлы\n                    subject_node = {\n                        'id': f\"{subject}_{i}\",\n                        'label': subject,\n                        'type': 'entity',\n                        'confidence': confidence,\n                        'language': language\n                    }\n                    object_node = {\n                        'id': f\"{obj}_{i}\",\n                        'label': obj,\n                        'type': 'entity', \n                        'confidence': confidence,\n                        'language': language\n                    }\n                    \n                    all_nodes.extend([subject_node, object_node])\n                    \n                    # Создаём связь\n                    edge = {\n                        'id': f\"edge_{i}\",\n                        'source': subject_node['id'],\n                        'target': object_node['id'],\n                        'label': predicate,\n                        'confidence': confidence,\n                        'language': language\n                    }\n                    all_edges.append(edge)\n                    \n            except Exception as e:\n                print(f\"Ошибка чтения {graph_file}: {e}\")\n                continue\n        \n        # Удаляем дубликаты узлов\n        unique_nodes = {}\n        for node in all_nodes:\n            key = node['label']\n            if key not in unique_nodes or unique_nodes[key]['confidence'] < node['confidence']:\n                unique_nodes[key] = node\n        \n        final_nodes = list(unique_nodes.values())\n        \n        # Обновляем ID в связях\n        node_id_map = {node['label']: node['id'] for node in final_nodes}\n        for edge in all_edges:\n            source_label = next((n['label'] for n in all_nodes if n['id'] == edge['source']), edge['source'])\n            target_label = next((n['label'] for n in all_nodes if n['id'] == edge['target']), edge['target'])\n            \n            if source_label in node_id_map and target_label in node_id_map:\n                edge['source'] = node_id_map[source_label]\n                edge['target'] = node_id_map[target_label]\n        \n        result = {\n            'graph': final_nodes,\n            'edges': all_edges,\n            'metadata': {\n                'total_nodes': len(final_nodes),\n                'total_edges': len(all_edges),\n                'total_triplets': total_triplets,\n                'processed_documents': processed_docs,\n                'languages': languages,\n                'last_updated': datetime.now().isoformat()\n            }\n        }\n        \n        return result\n        \n    except Exception as e:\n        return {'error': str(e), 'graph': [], 'edges': []}\n\n@app.get(\"/api/graph/stats\")\ndef get_graph_stats():\n    \"\"\"Статистика графа знаний\"\"\"\n    try:\n        graph_results_dir = Path(\"data/graph_results\")\n        if not graph_results_dir.exists():\n            return {'nodes': 0, 'edges': 0, 'documents': 0, 'triplets': 0, 'languages': {'ru': 0, 'en': 0}}\n        \n        # Читаем сводный отчёт\n        summary_file = graph_results_dir / \"processing_summary.json\"\n        if summary_file.exists():\n            with open(summary_file, 'r', encoding='utf-8') as f:\n                summary = json.load(f)\n            \n            return {\n                'nodes': summary.get('total_triplets', 0) * 2,  # Примерная оценка\n                'edges': summary.get('total_triplets', 0),\n                'documents': summary.get('processed_documents', 0),\n                'triplets': summary.get('total_triplets', 0),\n                'average_triplets_per_doc': summary.get('average_triplets_per_doc', 0),\n                'languages': summary.get('languages', {'ru': 0, 'en': 0})\n            }\n        \n        return {'nodes': 0, 'edges': 0, 'documents': 0, 'triplets': 0, 'languages': {'ru': 0, 'en': 0}}\n        \n    except Exception as e:\n        return {'error': str(e)}\n\n@app.post(\"/api/set_language\")\ndef set_language(payload: dict = Body(...)):\n    \"\"\"Устанавливает язык интерфейса\"\"\"\n    try:\n        lang = payload.get('lang', 'ru').lower()\n        \n        if lang not in ['ru', 'en']:\n            return {'status': 'error', 'message': 'Unsupported language'}\n        \n        # Создаем директорию для конфигурации\n        config_dir = Path(\"data/config\")\n        config_dir.mkdir(parents=True, exist_ok=True)\n        \n        # Сохраняем язык\n        lang_file = config_dir / \"lang.txt\"\n        lang_file.write_text(lang, encoding='utf-8')\n        \n        return {'status': 'ok', 'language': lang, 'message': f'Language set to {lang}'}\n        \n    except Exception as e:\n        return {'status': 'error', 'message': str(e)}\n\n@app.get(\"/api/get_language\")\ndef get_language():\n    \"\"\"Получает текущий язык интерфейса\"\"\"\n    try:\n        lang_file = Path(\"data/config/lang.txt\")\n        if lang_file.exists():\n            lang = lang_file.read_text(encoding='utf-8').strip()\n            return {'language': lang}\n        else:\n            return {'language': 'ru'}  # По умолчанию русский\n            \n    except Exception as e:\n        return {'language': 'ru', 'error': str(e)}\n\n@app.get('/metrics/prometheus')\ndef prom():\n    m = get_metrics_snapshot()\n    lines = [f\"ai_reps_{k.lower()} {m[k]}\" for k in ['RSS','COS','FAITH','Growth','Resonance','confidence']]\n    return Response(content='\\n'.join(lines)+'\\n', media_type='text/plain')\n\n@app.get(\"/api/audit/latest\")\ndef get_latest_audit():\n    \"\"\"Получение последнего отчёта аудита окружения\"\"\"\n    try:\n        audit_dir = Path(\"audit_reports/env\")\n        if not audit_dir.exists():\n            return {'error': 'No audit reports found'}\n        \n        # Ищем последний файл\n        audit_files = list(audit_dir.glob(\"cursor_env.json\"))\n        if not audit_files:\n            return {'error': 'No audit files found'}\n        \n        latest_file = max(audit_files, key=lambda f: f.stat().st_mtime)\n        \n        with open(latest_file, 'r', encoding='utf-8') as f:\n            audit_data = json.load(f)\n        \n        return audit_data\n        \n    except Exception as e:\n        return {'error': str(e)}"
        }
      ]
    },
    {
      "id": "update_dashboard",
      "name": "Обновление дашборда",
      "description": "Добавляем переключатель языка в дашборд",
      "files": [
        {
          "path": "src/api/static/index.html",
          "action": "update",
          "content": "<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>TERAG AI-REPS Dashboard</title>\n    <style>\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            margin: 0;\n            padding: 20px;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: #333;\n            min-height: 100vh;\n        }\n        \n        .container {\n            max-width: 1200px;\n            margin: 0 auto;\n            background: rgba(255, 255, 255, 0.95);\n            border-radius: 15px;\n            padding: 30px;\n            box-shadow: 0 20px 40px rgba(0,0,0,0.1);\n        }\n        \n        .header {\n            text-align: center;\n            margin-bottom: 30px;\n            border-bottom: 2px solid #eee;\n            padding-bottom: 20px;\n        }\n        \n        .header h1 {\n            color: #2c3e50;\n            margin: 0;\n            font-size: 2.5em;\n        }\n        \n        .header p {\n            color: #7f8c8d;\n            margin: 10px 0 0 0;\n            font-size: 1.1em;\n        }\n        \n        .language-selector {\n            position: absolute;\n            top: 20px;\n            right: 20px;\n            background: white;\n            padding: 10px;\n            border-radius: 8px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        }\n        \n        .language-selector select {\n            padding: 8px 12px;\n            border: 1px solid #ddd;\n            border-radius: 5px;\n            font-size: 14px;\n            background: white;\n        }\n        \n        .metrics-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n            gap: 20px;\n            margin-bottom: 30px;\n        }\n        \n        .metric-card {\n            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\n            color: white;\n            padding: 25px;\n            border-radius: 12px;\n            text-align: center;\n            box-shadow: 0 8px 25px rgba(0,0,0,0.15);\n            transition: transform 0.3s ease;\n        }\n        \n        .metric-card:hover {\n            transform: translateY(-5px);\n        }\n        \n        .metric-card h3 {\n            margin: 0 0 10px 0;\n            font-size: 1.1em;\n            opacity: 0.9;\n        }\n        \n        .metric-value {\n            font-size: 2.5em;\n            font-weight: bold;\n            margin: 10px 0;\n        }\n        \n        .status-indicator {\n            display: inline-block;\n            width: 12px;\n            height: 12px;\n            border-radius: 50%;\n            margin-right: 8px;\n        }\n        \n        .status-ok { background-color: #27ae60; }\n        .status-warning { background-color: #f39c12; }\n        .status-critical { background-color: #e74c3c; }\n        \n        .graph-stats {\n            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);\n            color: white;\n            padding: 25px;\n            border-radius: 12px;\n            margin-bottom: 30px;\n        }\n        \n        .graph-stats h2 {\n            margin: 0 0 20px 0;\n            font-size: 1.5em;\n        }\n        \n        .stats-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n            gap: 15px;\n        }\n        \n        .stat-item {\n            text-align: center;\n        }\n        \n        .stat-value {\n            font-size: 2em;\n            font-weight: bold;\n            margin-bottom: 5px;\n        }\n        \n        .stat-label {\n            font-size: 0.9em;\n            opacity: 0.8;\n        }\n        \n        .language-stats {\n            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);\n            color: white;\n            padding: 20px;\n            border-radius: 12px;\n            margin-bottom: 30px;\n        }\n        \n        .language-stats h3 {\n            margin: 0 0 15px 0;\n            font-size: 1.3em;\n        }\n        \n        .language-item {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 10px 0;\n            border-bottom: 1px solid rgba(255,255,255,0.2);\n        }\n        \n        .language-item:last-child {\n            border-bottom: none;\n        }\n        \n        .language-name {\n            font-weight: bold;\n            text-transform: uppercase;\n        }\n        \n        .language-count {\n            font-size: 1.2em;\n            font-weight: bold;\n        }\n        \n        .last-update {\n            text-align: center;\n            color: #7f8c8d;\n            font-size: 0.9em;\n            margin-top: 20px;\n        }\n        \n        .loading {\n            text-align: center;\n            padding: 20px;\n            color: #7f8c8d;\n        }\n        \n        .error {\n            background: #e74c3c;\n            color: white;\n            padding: 15px;\n            border-radius: 8px;\n            margin: 20px 0;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"language-selector\">\n            <select id=\"langSelector\" onchange=\"setLanguage(this.value)\">\n                <option value=\"ru\">Русский</option>\n                <option value=\"en\">English</option>\n            </select>\n        </div>\n        \n        <div class=\"header\">\n            <h1 id=\"mainTitle\">TERAG AI-REPS Dashboard</h1>\n            <p id=\"subtitle\">Система когнитивного резонанса и самообучения</p>\n        </div>\n        \n        <div id=\"content\">\n            <div class=\"loading\">Загрузка метрик...</div>\n        </div>\n    </div>\n\n    <script>\n        let currentLanguage = 'ru';\n        \n        const translations = {\n            ru: {\n                title: 'TERAG AI-REPS Dashboard',\n                subtitle: 'Система когнитивного резонанса и самообучения',\n                loading: 'Загрузка метрик...',\n                metrics: 'Метрики AI-REPS',\n                graphStats: 'Статистика графа знаний',\n                languageStats: 'Статистика по языкам',\n                documents: 'Документы',\n                triplets: 'Триплеты',\n                nodes: 'Узлы',\n                edges: 'Связи',\n                avgTriplets: 'Среднее триплетов на документ',\n                lastUpdate: 'Последнее обновление',\n                russian: 'Русский',\n                english: 'Английский'\n            },\n            en: {\n                title: 'TERAG AI-REPS Dashboard',\n                subtitle: 'Cognitive Resonance and Self-Learning System',\n                loading: 'Loading metrics...',\n                metrics: 'AI-REPS Metrics',\n                graphStats: 'Knowledge Graph Statistics',\n                languageStats: 'Language Statistics',\n                documents: 'Documents',\n                triplets: 'Triplets',\n                nodes: 'Nodes',\n                edges: 'Edges',\n                avgTriplets: 'Average triplets per document',\n                lastUpdate: 'Last update',\n                russian: 'Russian',\n                english: 'English'\n            }\n        };\n        \n        async function loadLanguage() {\n            try {\n                const response = await fetch('/api/get_language');\n                const data = await response.json();\n                currentLanguage = data.language || 'ru';\n                document.getElementById('langSelector').value = currentLanguage;\n                updateUI();\n            } catch (error) {\n                console.error('Error loading language:', error);\n                currentLanguage = 'ru';\n                updateUI();\n            }\n        }\n        \n        async function setLanguage(lang) {\n            try {\n                await fetch('/api/set_language', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({ lang })\n                });\n                \n                currentLanguage = lang;\n                updateUI();\n                loadMetrics();\n            } catch (error) {\n                console.error('Error setting language:', error);\n            }\n        }\n        \n        function updateUI() {\n            const t = translations[currentLanguage];\n            document.getElementById('mainTitle').textContent = t.title;\n            document.getElementById('subtitle').textContent = t.subtitle;\n        }\n        \n        async function loadMetrics() {\n            try {\n                const [metricsResponse, statsResponse] = await Promise.all([\n                    fetch('/api/metrics'),\n                    fetch('/api/graph/stats')\n                ]);\n                \n                const metrics = await metricsResponse.json();\n                const stats = await statsResponse.json();\n                \n                displayMetrics(metrics, stats);\n            } catch (error) {\n                console.error('Error loading metrics:', error);\n                document.getElementById('content').innerHTML = \n                    '<div class=\"error\">Ошибка загрузки метрик</div>';\n            }\n        }\n        \n        function displayMetrics(metrics, stats) {\n            const t = translations[currentLanguage];\n            \n            const content = `\n                <div class=\"metrics-grid\">\n                    <div class=\"metric-card\">\n                        <h3>RSS</h3>\n                        <div class=\"metric-value\">${metrics.RSS.toFixed(3)}</div>\n                    </div>\n                    <div class=\"metric-card\">\n                        <h3>COS</h3>\n                        <div class=\"metric-value\">${metrics.COS.toFixed(3)}</div>\n                    </div>\n                    <div class=\"metric-card\">\n                        <h3>FAITH</h3>\n                        <div class=\"metric-value\">${metrics.FAITH.toFixed(3)}</div>\n                    </div>\n                    <div class=\"metric-card\">\n                        <h3>Growth</h3>\n                        <div class=\"metric-value\">${metrics.Growth.toFixed(3)}</div>\n                    </div>\n                    <div class=\"metric-card\">\n                        <h3>Resonance</h3>\n                        <div class=\"metric-value\">${metrics.Resonance.toFixed(3)}</div>\n                    </div>\n                    <div class=\"metric-card\">\n                        <h3>Confidence</h3>\n                        <div class=\"metric-value\">${metrics.confidence.toFixed(3)}</div>\n                    </div>\n                </div>\n                \n                <div class=\"graph-stats\">\n                    <h2>${t.graphStats}</h2>\n                    <div class=\"stats-grid\">\n                        <div class=\"stat-item\">\n                            <div class=\"stat-value\">${stats.documents || 0}</div>\n                            <div class=\"stat-label\">${t.documents}</div>\n                        </div>\n                        <div class=\"stat-item\">\n                            <div class=\"stat-value\">${stats.triplets || 0}</div>\n                            <div class=\"stat-label\">${t.triplets}</div>\n                        </div>\n                        <div class=\"stat-item\">\n                            <div class=\"stat-value\">${stats.nodes || 0}</div>\n                            <div class=\"stat-label\">${t.nodes}</div>\n                        </div>\n                        <div class=\"stat-item\">\n                            <div class=\"stat-value\">${stats.edges || 0}</div>\n                            <div class=\"stat-label\">${t.edges}</div>\n                        </div>\n                        <div class=\"stat-item\">\n                            <div class=\"stat-value\">${(stats.average_triplets_per_doc || 0).toFixed(1)}</div>\n                            <div class=\"stat-label\">${t.avgTriplets}</div>\n                        </div>\n                    </div>\n                </div>\n                \n                ${stats.languages ? `\n                <div class=\"language-stats\">\n                    <h3>${t.languageStats}</h3>\n                    <div class=\"language-item\">\n                        <span class=\"language-name\">${t.russian}</span>\n                        <span class=\"language-count\">${stats.languages.ru || 0}</span>\n                    </div>\n                    <div class=\"language-item\">\n                        <span class=\"language-name\">${t.english}</span>\n                        <span class=\"language-count\">${stats.languages.en || 0}</span>\n                    </div>\n                </div>\n                ` : ''}\n                \n                <div class=\"last-update\">\n                    ${t.lastUpdate}: ${new Date().toLocaleString()}\n                </div>\n            `;\n            \n            document.getElementById('content').innerHTML = content;\n        }\n        \n        // Загружаем язык и метрики при загрузке страницы\n        document.addEventListener('DOMContentLoaded', () => {\n            loadLanguage();\n            loadMetrics();\n            \n            // Обновляем метрики каждые 5 секунд\n            setInterval(loadMetrics, 5000);\n        });\n    </script>\n</body>\n</html>"
        }
      ]
    },
    {
      "id": "test_multilingual",
      "name": "Тестирование многоязычности",
      "description": "Тестируем работу с русскими и английскими документами",
      "commands": [
        "python -c \"from src.core.doc_converter import detect_language; print('RU:', detect_language('Это русский текст для тестирования')); print('EN:', detect_language('This is English text for testing'))\"",
        "curl -s http://127.0.0.1:8000/api/get_language",
        "curl -s -X POST -H 'Content-Type: application/json' --data '{\"lang\":\"en\"}' http://127.0.0.1:8000/api/set_language",
        "curl -s http://127.0.0.1:8000/api/graph/stats"
      ]
    },
    {
      "id": "verify_dashboard",
      "name": "Проверка дашборда",
      "description": "Проверяем работу переключателя языка в дашборде",
      "verification": "Откройте http://127.0.0.1:8000/api/static/index.html и проверьте переключатель языка в правом верхнем углу"
    }
  ],
  "success_criteria": [
    "langdetect установлена и работает",
    "doc_converter.py определяет язык документов",
    "kag_builder.py обрабатывает документы по языкам",
    "API поддерживает переключение языка",
    "Дашборд имеет переключатель языка",
    "Статистика показывает количество документов по языкам"
  ]
}

































