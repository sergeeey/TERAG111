name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Typecheck
        run: npm run typecheck
      - name: Test
        run: npm run test

  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest
      - name: Lint (ruff)
        run: ruff check .
      - name: Typecheck (mypy)
        run: mypy --ignore-missing-imports .
      - name: Tests (pytest)
        run: pytest tests/ --cov=src --cov-report=json --cov-fail-under=40

  critical-path-tests:
    name: Critical Path Tests (metrics + retrievers)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          # Установка минимальных зависимостей для импорта модулей
          pip install -r requirements.txt || echo "Some dependencies may be missing, but tests should work with mocks"

      - name: Run critical-path tests with coverage
        run: |
          # D1.3: CI порог по coverage = 10% (фактическое ~15.4%).
          # Дальнейшие ступени: 15% и 20% по мере роста покрытия (см. TESTING_STATUS.md и FULL_AUDIT_REPORT.md).
          pytest tests/unit tests/retrievers tests/core/test_config.py tests/api/test_auth_api_key.py tests/api/test_auth_integration.py tests/api/test_guardrail_integration.py tests/csl/test_firewall.py \
            --cov=src/core/config.py \
            --cov=src/api/auth.py \
            --cov=src/core/security/guardrail_router.py \
            --cov=src/csl/firewall.py \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=10

  contract-compat:
    name: Contract Compatibility (TERAG API)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Generate JSON Schema from OpenAPI
        run: |
          python scripts/generate_terag_contract_schema.py

      - name: Validate TERAG API fixtures
        run: |
          python scripts/validate_terag_fixtures.py

      - name: Run contract tests
        run: |
          pytest tests/api/test_terag_v2_contract.py -v








