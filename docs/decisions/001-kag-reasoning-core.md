# ADR-001: Переход на KAG как reasoning-ядро

## Статус
✅ **Принято** - 2025-10-24

## Контекст

Текущая архитектура TERAG Immersive Shell использует простой RAG (Retrieval-Augmented Generation) подход, который имеет следующие ограничения:

1. **Низкая explainability** - система не может объяснить, как пришла к выводу
2. **Высокий риск галлюцинаций** - отсутствие валидации логических связей
3. **Отсутствие структурированных рассуждений** - ответы генерируются без логической цепочки
4. **Сложность валидации результатов** - нет способа проверить корректность ответов
5. **Ограниченная обучаемость** - система не учится на ошибках

## Решение

Переход на KAG (Knowledge-Augmented Generation) с использованием следующих компонентов:

### 1. OpenSPG как движок графов знаний
- **Схемно-ограниченный подход** - предотвращает галлюцинации
- **Высокая производительность** - оптимизирован для больших графов
- **Хорошая интеграция** - совместимость с Neo4j
- **Активное сообщество** - постоянные обновления и поддержка

### 2. KAG-Builder для извлечения знаний
- Извлечение SPO-триплетов (Subject-Predicate-Object)
- Валидация с использованием схемы OpenSPG
- Mutual indexing - связь узлов с исходными чанками
- Интеграция с Supabase для метаданных

### 3. KAG-Solver для структурированного reasoning
- Планирование логических шагов
- Выполнение рассуждений с валидацией
- Рефлексия и переформулировка при неудачах
- Логирование полного reasoning trace

### 4. Memory Bank для долговременной памяти
- Сохранение reasoning traces
- Анализ паттернов успеха и неудач
- Автоматическое обновление правил
- Перенос знаний между проектами

## Последствия

### Положительные последствия

1. **Повышение explainability до 100%**
   - Каждый ответ сопровождается reasoning trace
   - Пользователь может видеть логические шаги
   - Возможность валидации каждого шага

2. **Снижение галлюцинаций на 80%**
   - Схемно-ограниченный подход OpenSPG
   - Валидация SPO-триплетов
   - Проверка логической согласованности

3. **Структурированные рассуждения**
   - Четкая логическая цепочка
   - Возможность отладки reasoning
   - Улучшение качества ответов

4. **Возможность аудита reasoning**
   - Соответствие стандартам EU AI Act
   - Автоматическая оценка качества
   - Документирование всех решений

5. **Самообучение системы**
   - Анализ ошибок и успехов
   - Автоматическое обновление правил
   - Улучшение со временем

### Отрицательные последствия

1. **Усложнение архитектуры**
   - Больше компонентов для поддержки
   - Сложные интеграции между сервисами
   - Необходимость мониторинга всех компонентов

2. **Увеличение времени обработки**
   - Reasoning требует больше времени
   - Дополнительные валидации
   - Сложные запросы к графу

3. **Необходимость обучения команды**
   - Новые технологии (OpenSPG)
   - Сложные концепции (reasoning, рефлексия)
   - Изменение подходов к разработке

4. **Дополнительные зависимости**
   - OpenSPG и его зависимости
   - Дополнительные сервисы
   - Увеличение сложности деплоя

5. **Повышенные требования к ресурсам**
   - Больше памяти для графов
   - Вычислительные ресурсы для reasoning
   - Хранилище для traces и метаданных

## Альтернативы

### 1. Улучшение существующего RAG
**Описание:** Добавление валидации и explainability к текущему RAG
**Плюсы:** Минимальные изменения, быстрая реализация
**Минусы:** Недостаточная explainability, ограниченные возможности
**Решение:** Отклонено - недостаточно для достижения целей

### 2. Переход на другие фреймворки
**Описание:** Использование других графовых фреймворков (NetworkX, DGL)
**Плюсы:** Больше выбора, знакомые технологии
**Минусы:** Меньше возможностей для reasoning, хуже производительность
**Решение:** Отклонено - OpenSPG наиболее подходящий

### 3. Гибридный подход
**Описание:** Сочетание RAG и KAG для разных типов запросов
**Плюсы:** Гибкость, постепенная миграция
**Минусы:** Сложность интеграции, дублирование логики
**Решение:** Отклонено - слишком сложно для поддержки

## Критерии успеха

1. **Технические метрики:**
   - Faithfulness score > 0.8
   - Logic consistency > 0.9
   - Transparency index > 0.85
   - Время обработки < 5 секунд

2. **Пользовательские метрики:**
   - User satisfaction > 90%
   - Validation rate > 70%
   - Error rate < 5%

3. **Операционные метрики:**
   - Uptime > 99.9%
   - Response time < 2 секунд
   - Memory usage < 8GB

## План реализации

### Фаза 1: Архитектура (1 неделя)
- [x] Создание архитектурной диаграммы
- [x] Настройка OpenSPG
- [x] Интеграция с Neo4j
- [ ] Тестирование базовой функциональности

### Фаза 2: KAG-Builder (2 недели)
- [ ] Реализация извлечения SPO-триплетов
- [ ] Интеграция с OpenSPG
- [ ] Mutual indexing
- [ ] Тестирование и валидация

### Фаза 3: KAG-Solver (2 недели)
- [ ] Реализация reasoning логики
- [ ] Интеграция с Memory Bank
- [ ] Рефлексия и обучение
- [ ] Тестирование качества

### Фаза 4: UI интеграция (1 неделя)
- [ ] Cognitive Trace Viewer
- [ ] Интеграция с существующим UI
- [ ] Валидация пользователем
- [ ] Мониторинг и метрики

## Риски и митигация

### Высокие риски
1. **Сложность OpenSPG интеграции**
   - Митигация: Детальное изучение документации, создание POC
   
2. **Производительность reasoning**
   - Митигация: Профилирование, оптимизация, кэширование

3. **Качество извлечения SPO-триплетов**
   - Митигация: Тщательное тестирование, итеративное улучшение

### Средние риски
1. **Сложность UI интеграции**
   - Митигация: Поэтапная интеграция, обратная совместимость

2. **Обучение команды**
   - Митигация: Документация, обучение, менторство

## Заключение

Переход на KAG как reasoning-ядро критически важен для достижения целей TERAG по созданию объяснимого и надежного AI-агента. Несмотря на сложности реализации, преимущества значительно превышают риски.

**Решение принято единогласно всеми участниками.**

---

**Участники:**
- Cursor Agents (Architect, ML Engineer, DevOps)
- TERAG Team (Lead Developer, Product Manager)

**Дата принятия:** 2025-10-24  
**Дата пересмотра:** 2025-11-24





































