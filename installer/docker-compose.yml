services:
  # FastAPI Application
  terag-api:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: terag-api
    ports:
      - "8000:8000"
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - PROMETHEUS_PORT=${PROMETHEUS_PORT}
      - DATA_PATH=${DATA_PATH}
      - LLM_PROVIDER=${LLM_PROVIDER}
      - LLM_URL=${LLM_URL}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_FORCE_UTF8_FIX=${LLM_FORCE_UTF8_FIX:-true}
      - FASTAPI_PORT=${FASTAPI_PORT}
    volumes:
      - ${DATA_PATH}/cache:/app/cache
      - ${DATA_PATH}/logs:/app/logs
    depends_on:
      - neo4j
      - prometheus
    networks:
      - terag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Neo4j Database
  neo4j:
    image: neo4j:5.15-community
    container_name: terag-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - ${DATA_PATH}/neo4j/data:/data
      - ${DATA_PATH}/neo4j/logs:/logs
      - ${DATA_PATH}/neo4j/import:/var/lib/neo4j/import
      - ${DATA_PATH}/neo4j/plugins:/plugins
    networks:
      - terag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USER}", "-p", "${NEO4J_PASSWORD}", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheus Metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: terag-prometheus
    ports:
      - "${PROMETHEUS_PORT}:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ${DATA_PATH}/prometheus:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - terag-network
    restart: unless-stopped

  # Grafana Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: terag-grafana
    ports:
      - "${GRAFANA_PORT}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=terag_admin
      - GF_INSTALL_PLUGINS=redis-datasource
    volumes:
      - ${DATA_PATH}/grafana:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    networks:
      - terag-network
    restart: unless-stopped

networks:
  terag-network:
    name: terag_terag-network
    driver: bridge



